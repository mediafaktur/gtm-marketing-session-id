<script>
  /**
   * ============================================================================
   * MSID Persist & Decide — final session resolution
   * ============================================================================
   * Purpose:
   *   - Implements full session logic (identical to the original variable):
   *       * NEW session if external referrer OR inactivity timeout
   *       * CARRY if internal navigation within timeout and no tab ID
   *       * Otherwise keep existing tab ID
   *   - Persists the final ID to:
   *       * sessionStorage.ms_sessionId       (tab-scoped truth)
   *       * localStorage.ms_currentSessionId  (cross-tab continuity)
   *       * localStorage.ms_lastActivityTs    (last activity timestamp)
   *   - Syncs the final ID back into RAM (window.__ms.sessionId)
   *
   * Privacy:
   *   - Bound to consent trigger. All device storage reads/writes happen
   *     only here and only after opt-in.
   *
   * Sequencing:
   *   - Must run as Setup Tag ("Once per page") before GA4 & other dependent tags
   *   - Fully synchronous → no race conditions
   * ============================================================================
   */

(function () {

  // -------------------------------------------------------------------------
  // CONFIGURATION
  // -------------------------------------------------------------------------
  var TIMEOUT_MIN = 30;                 // inactivity window in minutes
  var REF_CHECK_MODE = "etld1";         // "etld1" | "hostname" | "custom"
  var INTERNAL_HOSTS = [];              // used only with "custom" mode

  // Normalize INTERNAL_HOSTS for robustness (lowercase, trim)
  if (INTERNAL_HOSTS && INTERNAL_HOSTS.length > 0) {
    INTERNAL_HOSTS = INTERNAL_HOSTS.map(function(host) {
      return (host || "").toString().toLowerCase().trim();
    }).filter(function(host) {
      return host.length > 0;
    });
  }

  // -------------------------------------------------------------------------
  // HELPERS
  // -------------------------------------------------------------------------
  function lsGet(k) { try { return localStorage.getItem(k); } catch (e) { return null; } }
  function ssGet(k) { try { return sessionStorage.getItem(k); } catch (e) { return null; } }
  function lsSet(k, v) { try { localStorage.setItem(k, v); } catch (e) { } }
  function ssSet(k, v) { try { sessionStorage.setItem(k, v); } catch (e) { } }

  function etld1(host) {
    try {
      var normalizedHost = (host || "").toLowerCase();
      var p = normalizedHost.split(".");
      return p.length >= 2 ? p.slice(-2).join(".") : normalizedHost;
    } catch (e) { return (host || "").toLowerCase(); }
  }

  function getRefHost() {
    try {
      if (!document.referrer) return "";
      return (new URL(document.referrer).hostname || "").toLowerCase();
    } catch (e) {
      var a = document.createElement("a");
      a.href = document.referrer || "";
      return (a.hostname || "").toLowerCase();
    }
  }

  function isExternalReferrer(refHost, pageHost) {
    if (!refHost) return false;
    if (REF_CHECK_MODE === "hostname") return refHost !== pageHost;
    if (REF_CHECK_MODE === "custom") {
      var refIn = INTERNAL_HOSTS.indexOf(refHost) !== -1;
      var pageIn = INTERNAL_HOSTS.indexOf(pageHost) !== -1;
      if (!refIn && !pageIn) return etld1(refHost) !== etld1(pageHost);
      return !(refIn && pageIn);
    }
    return etld1(refHost) !== etld1(pageHost); // default: eTLD+1
  }

  function genId(ts) {
    var randomPart;
    try {
      // Use crypto.getRandomValues if available for better randomness
      if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
        var array = new Uint8Array(6);
        window.crypto.getRandomValues(array);
        // IE11-compatible alternative to Array.from()
        var result = [];
        for (var i = 0; i < array.length; i++) {
          result.push(array[i].toString(36));
        }
        randomPart = result.join('').slice(0, 8);
      } else {
        // Fallback to Math.random for older browsers
        randomPart = Math.random().toString(36).slice(2, 10);
      }
    } catch (e) {
      // Ultimate fallback
      randomPart = Math.random().toString(36).slice(2, 10);
    }
    return "session_" + ts + "_" + randomPart;
  }

  // -------------------------------------------------------------------------
  // 0) IDEMPOTENT GUARD (prevent double execution)
  // -------------------------------------------------------------------------
  // Check if this tag has already run on this page
  if (window.__ms && window.__ms._persistExecuted) {
    return; // Skip if already executed
  }

  // -------------------------------------------------------------------------
  // 1) PRE-FETCH RAM ID (no device storage access)
  // -------------------------------------------------------------------------
  var current = {{msSessionId}};

  // -------------------------------------------------------------------------
  // 2) SIGNALS
  // -------------------------------------------------------------------------
  var now = Date.now();
  var pageHost = location.hostname.toLowerCase();
  var refHost = getRefHost();
  var isExternalRef = isExternalReferrer(refHost, pageHost);

  // -------------------------------------------------------------------------
  // 3) CURRENT STATE (storage reads — consent-bound)
  // -------------------------------------------------------------------------
  var lastTs = +(lsGet("ms_lastActivityTs") || 0);
  var inactiveTooLong = lastTs ? ((now - lastTs) > (TIMEOUT_MIN * 60 * 1000)) : false;

  var sid = ssGet("ms_sessionId");        // tab-scoped ID
  var carry = lsGet("ms_currentSessionId"); // cross-tab candidate

  var shouldCarry = !sid && !!carry && !inactiveTooLong && !isExternalRef;
  var isStart = (!sid && !shouldCarry) || isExternalRef || inactiveTooLong;

  // -------------------------------------------------------------------------
  // 4) RESOLUTION (exactly as original)
  // -------------------------------------------------------------------------
  var finalSid;
  if (isStart) {
    finalSid = genId(now);
  } else if (!sid && shouldCarry) {
    finalSid = carry;
  } else if (!sid) {
    finalSid = genId(now);
  } else {
    finalSid = sid;
  }

  // -------------------------------------------------------------------------
  // 5) STORAGE WRITES (consent-bound)
  // -------------------------------------------------------------------------
  ssSet('ms_sessionId', String(finalSid));
  if (isStart || shouldCarry) {
    lsSet('ms_currentSessionId', String(finalSid));
  }
  lsSet('ms_lastActivityTs', String(now));

  // -------------------------------------------------------------------------
  // 6) SYNC TO RAM
  // -------------------------------------------------------------------------
  window.__ms = window.__ms || {};
  window.__ms.sessionId = String(finalSid);
  delete window.__ms.ephemeral;

  // Mark as executed to prevent double execution
  window.__ms._persistExecuted = true;

  // Debug signals (optional)
  window.__ms._signals = {
    now: now,
    refHost: refHost,
    pageHost: pageHost,
    refCheckMode: REF_CHECK_MODE,
    isExternalRef: !!isExternalRef,
    inactiveTooLong: !!inactiveTooLong,
    isStart: !!isStart,
    carryAllowed: !!shouldCarry
  };

  // -------------------------------------------------------------------------
  // 7) NOTIFY OTHER SCRIPTS (CustomEvent)
  // -------------------------------------------------------------------------
  try {
    document.dispatchEvent(new CustomEvent('msid:ready', {
      detail: {
        sessionId: window.__ms.sessionId,
        signals: window.__ms._signals
      }
    }));
  } catch(e) {
    // fallback for very old browsers without CustomEvent
    try {
      var evt = document.createEvent('CustomEvent');
      evt.initCustomEvent('msid:ready', false, false, {
        sessionId: window.__ms.sessionId,
        signals: window.__ms._signals
      });
      document.dispatchEvent(evt);
    } catch(e2) {
      // Ultimate fallback: simple event without detail
      var evt = document.createEvent('Event');
      evt.initEvent('msid:ready', false, false);
      document.dispatchEvent(evt);
    }
  }

}) ();
</script>
