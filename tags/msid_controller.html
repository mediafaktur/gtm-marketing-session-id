<script>
  /**
   * ============================================================================
   * MSID Persist & Decide — final session resolution
   * ============================================================================
   * Purpose:
   *   - Implements full session logic (identical to the original variable):
   *       * NEW session if external referrer OR inactivity timeout
   *       * CARRY if internal navigation within timeout and no tab ID
   *       * Otherwise keep existing tab ID
   *   - Persists the final ID to:
   *       * sessionStorage.ms_sessionId       (tab-scoped truth)
   *       * localStorage.ms_currentSessionId  (cross-tab continuity)
   *       * localStorage.ms_lastActivityTs    (last activity timestamp)
   *   - Syncs the final ID back into RAM (window.__ms.sessionId)
   *
   * Privacy:
   *   - Bound to consent trigger. All device storage reads/writes happen
   *     only here and only after opt-in.
   *
   * Sequencing:
   *   - Must run as Setup Tag ("Once per page") before GA4 & other dependent tags
   *   - Fully synchronous → no race conditions
   * ============================================================================
   */

(function () {

  // -------------------------------------------------------------------------
  // CONFIGURATION
  // -------------------------------------------------------------------------
  var TIMEOUT_MIN = 30;                 // inactivity window in minutes
  var REF_CHECK_MODE = "etld1";         // "etld1" | "hostname" | "custom"
  var INTERNAL_HOSTS = [];              // used only with "custom" mode

  // -------------------------------------------------------------------------
  // HELPERS
  // -------------------------------------------------------------------------
  function lsGet(k) { try { return localStorage.getItem(k); } catch (e) { return null; } }
  function ssGet(k) { try { return sessionStorage.getItem(k); } catch (e) { return null; } }
  function lsSet(k, v) { try { localStorage.setItem(k, v); } catch (e) { } }
  function ssSet(k, v) { try { sessionStorage.setItem(k, v); } catch (e) { } }

  function etld1(host) {
    try {
      var p = (host || "").split(".");
      return p.length >= 2 ? p.slice(-2).join(".") : (host || "");
    } catch (e) { return host || ""; }
  }

  function getRefHost() {
    try {
      if (!document.referrer) return "";
      return new URL(document.referrer).hostname || "";
    } catch (e) {
      var a = document.createElement("a");
      a.href = document.referrer || "";
      return a.hostname || "";
    }
  }

  function isExternalReferrer(refHost, pageHost) {
    if (!refHost) return false;
    if (REF_CHECK_MODE === "hostname") return refHost !== pageHost;
    if (REF_CHECK_MODE === "custom") {
      var refIn = INTERNAL_HOSTS.indexOf(refHost) !== -1;
      var pageIn = INTERNAL_HOSTS.indexOf(pageHost) !== -1;
      if (!refIn && !pageIn) return etld1(refHost) !== etld1(pageHost);
      return !(refIn && pageIn);
    }
    return etld1(refHost) !== etld1(pageHost); // default: eTLD+1
  }

  function genId(ts) {
    return "session_" + ts + "_" + Math.random().toString(36).slice(2, 10);
  }

  // -------------------------------------------------------------------------
  // 0) PRE-FETCH RAM ID (no device storage access)
  // -------------------------------------------------------------------------
  var current = {{msSessionId}};

  // -------------------------------------------------------------------------
  // 1) SIGNALS
  // -------------------------------------------------------------------------
  var now = Date.now();
  var pageHost = location.hostname;
  var refHost = getRefHost();
  var isExternalRef = isExternalReferrer(refHost, pageHost);

  // -------------------------------------------------------------------------
  // 2) CURRENT STATE (storage reads — consent-bound)
  // -------------------------------------------------------------------------
  var lastTs = +(lsGet("ms_lastActivityTs") || 0);
  var inactiveTooLong = lastTs ? ((now - lastTs) > (TIMEOUT_MIN * 60 * 1000)) : false;

  var sid = ssGet("ms_sessionId");        // tab-scoped ID
  var carry = lsGet("ms_currentSessionId"); // cross-tab candidate

  var shouldCarry = !sid && !!carry && !inactiveTooLong && !isExternalRef;
  var isStart = (!sid && !shouldCarry) || isExternalRef || inactiveTooLong;

  // -------------------------------------------------------------------------
  // 3) RESOLUTION (exactly as original)
  // -------------------------------------------------------------------------
  var finalSid;
  if (isStart) {
    finalSid = genId(now);
  } else if (!sid && shouldCarry) {
    finalSid = carry;
  } else if (!sid) {
    finalSid = genId(now);
  } else {
    finalSid = sid;
  }

  // -------------------------------------------------------------------------
  // 4) STORAGE WRITES (consent-bound)
  // -------------------------------------------------------------------------
  ssSet('ms_sessionId', String(finalSid));
  if (isStart || shouldCarry) {
    lsSet('ms_currentSessionId', String(finalSid));
  }
  lsSet('ms_lastActivityTs', String(now));

  // -------------------------------------------------------------------------
  // 5) SYNC TO RAM
  // -------------------------------------------------------------------------
  window.__ms = window.__ms || {};
  window.__ms.sessionId = String(finalSid);
  delete window.__ms.ephemeral;

  // Debug signals (optional)
  window.__ms._signals = {
    now: now,
    refHost: refHost,
    pageHost: pageHost,
    refCheckMode: REF_CHECK_MODE,
    isExternalRef: !!isExternalRef,
    inactiveTooLong: !!inactiveTooLong,
    isStart: !!isStart,
    carryAllowed: !!shouldCarry
  };

  // -------------------------------------------------------------------------
  // 6) NOTIFY OTHER SCRIPTS (CustomEvent)
  // -------------------------------------------------------------------------
  try {
    document.dispatchEvent(new CustomEvent('msid:ready', {
      detail: {
        sessionId: window.__ms.sessionId,
        signals: window.__ms._signals
      }
    }));
  } catch(e) {
    // fallback for very old browsers without CustomEvent
    var evt = document.createEvent('CustomEvent');
    evt.initCustomEvent('msid:ready', false, false, {
      sessionId: window.__ms.sessionId,
      signals: window.__ms._signals
    });
    document.dispatchEvent(evt);
  }

}) ();
</script>
